Bootstrap: docker
From: ubuntu:20.04

%files

	# copy common functions used in the various steps
	install-scripts-singularity/rinstall_funs.sh /home
	install-scripts-singularity/01_install_environment.sh /home
	install-scripts-singularity/02_install_mongodb.sh /home
	install-scripts-singularity/03_install_R.sh /home
	install-scripts-singularity/04_install_talys.sh /home
	install-scripts-singularity/05_download_exfor_data.sh /home
	install-scripts-singularity/06_prepare_user.sh /home
	install-scripts-singularity/07_install_custom_packages.sh /home
	install-scripts-singularity/08_install_pipeline.sh /home
	install-scripts-singularity/09_final_actions.sh /home
	install-scripts-singularity/startup.sh /home
	install-scripts-singularity/build_EXFOR_mongoDB.sh /home
	install-scripts-singularity/start_EXFOR_mongoDB.sh /home
	install-scripts-singularity/install_OMPI.sh /home
	install-scripts-singularity/install_clusterTALYS_mpi.sh /home
	install-scripts-singularity/compare-blas.sh /usr/local/bin
	install-scripts-singularity/test_blas.R /usr/local/bin

	# copy utility functions for the rstudio server
	install-scripts-singularity/rstudio_auth.sh /usr/lib/rstudio-server/bin/rstudio_auth
	install-scripts-singularity/start-rstudio.sh /usr/lib/rstudio-server/bin/start-rstudio

%environment

	export PATH=/usr/lib/rstudio-server/bin:${PATH}

    export instpath="/opt/pipeline/install"
	export instpath_R="$instpath/Rpackages"
	export instpath_R2="$instpath/Rcode"
	export instpath_DL="$instpath/downloads"
	export instpath_exfor="$instpath/exfor"
	export instpath_exfor_text="$instpath_exfor/text"

	export OMPI_DIR=/opt/ompi
	export PATH=$OMPI_DIR/bin:$PATH
	export LD_LIBRARY_PATH=$OMPI_DIR/lib:$LD_LIBRARY_PATH
	
	export maxNumCPU=32

	export repourl_R="https://cran.rstudio.com"
	export gitrepo="https://github.com/gschnabel"

%post
    ##################################################
	#       CONFIGURATION VARIABLES
	##################################################

	# select the open-mpi version to be installed
	export OMPI_VERSION=4.0.0

	# user account inside the container
	export username="username"
	export password="password"

	# path to use for downloaded files
	export instpath="/opt/pipeline/install"

	# url to the talys archive
	# if talysurl="", talys will not be downloaded
	export talysurl="http://www.nucleardata.com/storage/repos/talys/talys1.95.tar"

	# installation files to keep

	# keep the source code of custom R packages
	# after download and installation
	export keep_Rcodes="yes"

	# keep the EXFOR master files after
	# they have been fed into the MongoDB database
	export keep_exfor="no"

	##################################################
	#       SPECIFIC INSTALLATION PATHS 
	##################################################

	export instpath="/opt/pipeline/install"
	export instpath_R="$instpath/Rpackages"
	export instpath_R2="$instpath/Rcode"
	export instpath_DL="$instpath/downloads"
	export instpath_exfor="$instpath/exfor"
	export instpath_exfor_text="$instpath_exfor/text"

	export repourl_R="https://cran.rstudio.com"
	export gitrepo="https://github.com/gschnabel"

	# user ID and group ID of the associated
	# user account outside the container
	export extUID=1000
	export extGID=1000
	export maxNumCPU=32

	export OMPI_DIR=/opt/ompi
	export PATH=$OMPI_DIR/bin:$PATH
	export LD_LIBRARY_PATH=$OMPI_DIR/lib:$LD_LIBRARY_PATH

	##################################################
	#       IMAGE BUILDING
	##################################################

	mkdir -p $instpath
	cd $instpath
	mv /home/rinstall_funs.sh .
	mv /home/01_install_environment.sh .
	mv /home/02_install_mongodb.sh .
	mv /home/03_install_R.sh .
	mv /home/04_install_talys.sh .
	mv /home/05_download_exfor_data.sh .
	mv /home/06_prepare_user.sh .
	mv /home/07_install_custom_packages.sh .
	mv /home/08_install_pipeline.sh .
	mv /home/09_final_actions.sh .
	mv /home/startup.sh .
	mv /home/install_OMPI.sh .
	mv /home/install_clusterTALYS_mpi.sh .

	chmod 755 /usr/local/bin/compare-blas.sh

	mv /home/build_EXFOR_mongoDB.sh /usr/local/bin
	chmod 755 /usr/local/bin/build_EXFOR_mongoDB.sh

	mv /home/start_EXFOR_mongoDB.sh /usr/local/bin
	chmod 755 /usr/local/bin/start_EXFOR_mongoDB.sh

	chmod 744 $instpath/rinstall_funs.sh

	chmod 744 $instpath/01_install_environment.sh
	/bin/bash -c "source $instpath/01_install_environment.sh"

#	chmod 744 $instpath/install_OMPI.sh
#	/bin/bash -c "source $instpath/install_OMPI.sh"

#	chmod 744 $instpath/02_install_mongodb.sh
#	/bin/bash -c "source $instpath/02_install_mongodb.sh"
	
	chmod 744 $instpath/03_install_R.sh
	/bin/bash -c "source $instpath/rinstall_funs.sh && source $instpath/03_install_R.sh"
	
#	chmod 744 $instpath/04_install_talys.sh
#	/bin/bash -c "source $instpath/04_install_talys.sh"
	
#	chmod 744 $instpath/05_download_exfor_data.sh
#	/bin/bash -c "source $instpath/rinstall_funs.sh && source $instpath/05_download_exfor_data.sh"

#	chmod 744 $instpath/07_install_custom_packages.sh
#	/bin/bash -c "source $instpath/rinstall_funs.sh && source $instpath/07_install_custom_packages.sh"
	
#	chmod 744 $instpath/08_install_pipeline.sh
#	/bin/bash -c "source $instpath/rinstall_funs.sh && source $instpath/08_install_pipeline.sh"

#	chmod 744 $instpath/install_clusterTALYS_mpi.sh
#	/bin/bash -c "source $instpath/install_clusterTALYS_mpi.sh"

%runscript
    echo "runscript is run"
    echo "Container was created $NOW"
    echo "Arguments received: $*"
    #exec echo "$@"
    #/bin/bash -c "source $instpath/startup.sh"

